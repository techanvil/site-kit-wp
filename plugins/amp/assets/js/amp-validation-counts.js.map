{"version":3,"file":"amp-validation-counts.js","mappings":"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","sources":["webpack://amp-wp/./assets/src/amp-validation/counts/style.css?81e2","webpack://amp-wp/external window [\"wp\",\"apiFetch\"]","webpack://amp-wp/external window [\"wp\",\"domReady\"]","webpack://amp-wp/external window [\"wp\",\"i18n\"]","webpack://amp-wp/webpack/bootstrap","webpack://amp-wp/webpack/runtime/compat get default export","webpack://amp-wp/webpack/runtime/define property getters","webpack://amp-wp/webpack/runtime/hasOwnProperty shorthand","webpack://amp-wp/webpack/runtime/make namespace object","webpack://amp-wp/./assets/src/amp-validation/counts/index.js"],"sourcesContent":["// extracted by mini-css-extract-plugin\nexport {};","module.exports = window[\"wp\"][\"apiFetch\"];","module.exports = window[\"wp\"][\"domReady\"];","module.exports = window[\"wp\"][\"i18n\"];","// The module cache\nvar __webpack_module_cache__ = {};\n\n// The require function\nfunction __webpack_require__(moduleId) {\n\t// Check if module is in cache\n\tvar cachedModule = __webpack_module_cache__[moduleId];\n\tif (cachedModule !== undefined) {\n\t\treturn cachedModule.exports;\n\t}\n\t// Create a new module (and put it into the cache)\n\tvar module = __webpack_module_cache__[moduleId] = {\n\t\t// no module.id needed\n\t\t// no module.loaded needed\n\t\texports: {}\n\t};\n\n\t// Execute the module function\n\t__webpack_modules__[moduleId](module, module.exports, __webpack_require__);\n\n\t// Return the exports of the module\n\treturn module.exports;\n}\n\n","// getDefaultExport function for compatibility with non-harmony modules\n__webpack_require__.n = function(module) {\n\tvar getter = module && module.__esModule ?\n\t\tfunction() { return module['default']; } :\n\t\tfunction() { return module; };\n\t__webpack_require__.d(getter, { a: getter });\n\treturn getter;\n};","// define getter functions for harmony exports\n__webpack_require__.d = function(exports, definition) {\n\tfor(var key in definition) {\n\t\tif(__webpack_require__.o(definition, key) && !__webpack_require__.o(exports, key)) {\n\t\t\tObject.defineProperty(exports, key, { enumerable: true, get: definition[key] });\n\t\t}\n\t}\n};","__webpack_require__.o = function(obj, prop) { return Object.prototype.hasOwnProperty.call(obj, prop); }","// define __esModule on exports\n__webpack_require__.r = function(exports) {\n\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n\t}\n\tObject.defineProperty(exports, '__esModule', { value: true });\n};","/**\n * WordPress dependencies\n */\nimport { __ } from '@wordpress/i18n';\nimport apiFetch from '@wordpress/api-fetch';\nimport domReady from '@wordpress/dom-ready';\n\n/**\n * Internal dependencies\n */\nimport './style.css';\n\n/**\n * Get session storage key for storing the previously-fetched count.\n *\n * @param {string} itemId Menu item ID.\n * @return {string} Session storage key.\n */\nfunction getSessionStorageKey( itemId ) {\n\treturn `${ itemId }-last-count`;\n}\n\n/**\n * Sets the loading state on a menu item.\n *\n * @param {string} itemId Menu item ID.\n */\nfunction setMenuItemIsLoading( itemId ) {\n\tconst itemEl = document.getElementById( itemId );\n\n\tif ( ! itemEl || itemEl.querySelector( '.amp-count-loading' ) ) {\n\t\treturn;\n\t}\n\n\t// Add a loading spinner if we haven't obtained the count before or the last count was not zero.\n\tconst lastCount = sessionStorage.getItem( getSessionStorageKey( itemId ) );\n\tif ( ! lastCount || '0' !== lastCount ) {\n\t\tconst loadingEl = document.createElement( 'span' );\n\t\tloadingEl.classList.add( 'amp-count-loading' );\n\t\titemEl.append( loadingEl );\n\n\t\titemEl.classList.add( 'awaiting-mod' );\n\t}\n}\n\n/**\n * Sets a menu item count value.\n *\n * If the count is not a number or is `0`, the element that contains the count is instead removed (as it would be no\n * longer relevant).\n *\n * @param {string} itemId Menu item ID.\n * @param {number} count  Count to set.\n */\nfunction setMenuItemCountValue( itemId, count ) {\n\tconst itemEl = document.getElementById( itemId );\n\n\tif ( ! itemEl ) {\n\t\treturn;\n\t}\n\n\tif ( isNaN( count ) || count === 0 ) {\n\t\titemEl.parentNode.removeChild( itemEl );\n\t\tsessionStorage.setItem( getSessionStorageKey( itemId ), '0' );\n\t} else {\n\t\tconst text = count.toLocaleString();\n\t\titemEl.textContent = text;\n\t\titemEl.classList.add( 'awaiting-mod' ); // In case it wasn't set in setMenuItemIsLoading().\n\t\tsessionStorage.setItem( getSessionStorageKey( itemId ), text );\n\t}\n}\n\n/**\n * Initializes the 'Validated URLs' and 'Error Index' menu items.\n */\nfunction initializeMenuItemCounts() {\n\tsetMenuItemIsLoading( 'amp-new-error-index-count' );\n\tsetMenuItemIsLoading( 'amp-new-validation-url-count' );\n}\n\n/**\n * Updates the 'Validated URLs' and 'Error Index' menu items with their respective unreviewed count.\n *\n * @param {Object} counts                Counts for menu items.\n * @param {number} counts.validated_urls Unreviewed validated URLs count.\n * @param {number} counts.errors         Unreviewed validation errors count.\n */\nfunction updateMenuItemCounts( counts ) {\n\tconst { validated_urls: newValidatedUrlCount, errors: newErrorCount } = counts;\n\n\tsetMenuItemCountValue( 'amp-new-error-index-count', newErrorCount );\n\tsetMenuItemCountValue( 'amp-new-validation-url-count', newValidatedUrlCount );\n}\n\n/**\n * Requests validation counts.\n */\nfunction fetchValidationCounts() {\n\tapiFetch( { path: '/amp/v1/unreviewed-validation-counts' } ).then( ( counts ) => {\n\t\tupdateMenuItemCounts( counts );\n\t} ).catch( ( error ) => {\n\t\tupdateMenuItemCounts( { validated_urls: 0, errors: 0 } );\n\n\t\tconst message = error?.message || __( 'An unknown error occurred while retrieving the validation counts', 'amp' );\n\t\t// eslint-disable-next-line no-console\n\t\tconsole.error( `[AMP Plugin] ${ message }` );\n\t} );\n}\n\n/**\n * Fetches the validation counts only when the AMP submenu is open for the first time.\n *\n * @param {HTMLElement} root AMP submenu item.\n */\nfunction createObserver( root ) {\n\t// IntersectionObserver is not available in IE11, so just hide the counts entirely for that browser.\n\tif ( ! ( 'IntersectionObserver' in window ) ) {\n\t\tupdateMenuItemCounts( { validated_urls: 0, errors: 0 } );\n\t\treturn;\n\t}\n\n\tconst target = root.querySelector( 'ul' );\n\n\tconst observer = new IntersectionObserver( ( [ entry ] ) => {\n\t\tif ( ! entry || ! entry.isIntersecting ) {\n\t\t\treturn;\n\t\t}\n\n\t\tobserver.unobserve( target );\n\n\t\tfetchValidationCounts();\n\t}, { root } );\n\n\tobserver.observe( target );\n}\n\ndomReady( () => {\n\tconst ampMenuItem = document.getElementById( 'toplevel_page_amp-options' );\n\n\t// Bail if the AMP submenu is not in the DOM.\n\tif ( ! ampMenuItem ) {\n\t\treturn;\n\t}\n\n\tinitializeMenuItemCounts();\n\n\t// If the AMP submenu is opened, fetch validation counts as soon as possible. Thanks to the preload middleware for\n\t// `wp.apiFetch`, the validation count data should be available right away, so no actual HTTP request will be made.\n\tif ( ampMenuItem.classList.contains( 'wp-menu-open' ) ) {\n\t\tfetchValidationCounts();\n\t} else {\n\t\tcreateObserver( ampMenuItem );\n\t}\n} );\n"],"names":["__","apiFetch","domReady","getSessionStorageKey","itemId","setMenuItemIsLoading","itemEl","document","getElementById","querySelector","lastCount","sessionStorage","getItem","loadingEl","createElement","classList","add","append","setMenuItemCountValue","count","isNaN","parentNode","removeChild","setItem","text","toLocaleString","textContent","initializeMenuItemCounts","updateMenuItemCounts","counts","validated_urls","newValidatedUrlCount","errors","newErrorCount","fetchValidationCounts","path","then","catch","error","message","console","createObserver","root","window","target","observer","IntersectionObserver","entry","isIntersecting","unobserve","observe","ampMenuItem","contains"],"sourceRoot":""}